{% extends "base.html" %}

{% block title %}–û—Ç—á–µ—Ç—ã - –°–∫–ª–∞–¥—Å–∫–æ–π —É—á–µ—Ç{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4"><i class="fas fa-chart-bar me-2"></i>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤</h2>
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i>
        <strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤:</strong> –í –æ—Ç—á–µ—Ç–∞—Ö –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Å—Ç–∞–≤–Ω—ã–º –∞—Ä—Ç–∏–∫—É–ª–∞–º.
        <span class="badge bg-info ms-2">üß© —Å–æ—Å—Ç–∞–≤–Ω–æ–π</span>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á–µ—Ç–∞</h5>
                </div>
                <div class="card-body">
                    <form id="reportForm">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="date" class="form-control" id="startDate" 
                                   value="{{ now().strftime('%Y-%m-01') }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="endDate" class="form-label">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="date" class="form-control" id="endDate" 
                                   value="{{ now().strftime('%Y-%m-%d') }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reportType" class="form-label">–¢–∏–ø –æ—Ç—á–µ—Ç–∞</label>
                            <select class="form-select" id="reportType">
                                <option value="all">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
                                <option value="–ü—Ä–∏—Ö–æ–¥">–¢–æ–ª—å–∫–æ –ø—Ä–∏—Ö–æ–¥—ã</option>
                                <option value="–†–∞—Å—Ö–æ–¥">–¢–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã</option>
                                <option value="–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è">–¢–æ–ª—å–∫–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="productSearch" class="form-label">–¢–æ–≤–∞—Ä (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ—Ö)</label>
                            <input type="text" class="form-control" id="productSearch" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
                            <div id="searchResults" class="list-group mt-2" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        
                        <input type="hidden" id="selectedArticle">
                        
                        <button type="button" class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-sync me-1"></i>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h5>
                    <div>
                        <button class="btn btn-sm btn-light me-1" onclick="exportToExcel()" id="exportBtn" style="display: none;">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </button>
                        <button class="btn btn-sm btn-light" onclick="printReport()" id="printBtn" style="display: none;">
                            <i class="fas fa-print me-1"></i>–ü–µ—á–∞—Ç—å
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="reportResults">
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-chart-line fa-4x mb-3"></i>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–µ—Ç–∞–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsModalBody">
            </div>
        </div>
    </div>
</div>

<script>
let currentReportData = { summary: [], detailed: [] };
let compositeStats = { total: 0, orders: [] };

// –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤
let searchTimeout;
document.getElementById('productSearch')?.addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value;
    
    if (query.length < 2) {
        document.getElementById('searchResults').innerHTML = '';
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetch('/products/search?q=' + encodeURIComponent(query))
            .then(response => response.json())
            .then(products => {
                let html = '';
                products.forEach(product => {
                    const isComposite = product.article && product.article.includes('_');
                    html += `<a href="#" class="list-group-item list-group-item-action" 
                             onclick="selectProduct('${product.article}', '${product.name.replace(/'/g, "\\'")}')">
                             <strong>${product.name}</strong>
                             ${isComposite ? '<span class="badge bg-info ms-2">—Å–æ—Å—Ç–∞–≤–Ω–æ–π</span>' : ''}
                             <br>
                             <small>–ê—Ä—Ç. ${product.article} (–æ—Å—Ç–∞—Ç–æ–∫: ${product.stock})</small>
                             </a>`;
                });
                document.getElementById('searchResults').innerHTML = html;
            });
    }, 300);
});

function selectProduct(article, name) {
    document.getElementById('selectedArticle').value = article;
    document.getElementById('productSearch').value = name;
    document.getElementById('searchResults').innerHTML = '';
}

function generateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const reportType = document.getElementById('reportType').value;
    const article = document.getElementById('selectedArticle').value;
    
    if (!startDate || !endDate) {
        Swal.fire({
            title: '–û—à–∏–±–∫–∞!',
            text: '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥',
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    document.getElementById('reportResults').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</p>
        </div>
    `;
    
    fetch('/reports/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            start_date: startDate,
            end_date: endDate,
            report_type: reportType,
            article: article
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentReportData = data;
            compositeStats = data.composite_stats || { total: 0, orders: [] };
            displayReport(data.summary, data.detailed);
        } else {
            showError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞');
    });
}

function displayReport(summary, detailed) {
    if (!summary || summary.length === 0) {
        document.getElementById('reportResults').innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-info-circle fa-4x mb-3"></i>
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
            </div>
        `;
        document.getElementById('exportBtn').style.display = 'none';
        document.getElementById('printBtn').style.display = 'none';
        return;
    }
    
    document.getElementById('exportBtn').style.display = 'inline-block';
    document.getElementById('printBtn').style.display = 'inline-block';
    
    let html = '<div class="table-responsive">';
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Å—Ç–∞–≤–Ω—ã–º –∞—Ä—Ç–∏–∫—É–ª–∞–º
    if (compositeStats.total > 0) {
        html += `
            <div class="alert alert-info mb-3">
                <i class="fas fa-puzzle-piece me-2"></i>
                <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Å—Ç–∞–≤–Ω—ã–º –∞—Ä—Ç–∏–∫—É–ª–∞–º:</strong>
                –í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π: ${compositeStats.total}, –≤ –∑–∞–∫–∞–∑–∞—Ö: ${compositeStats.orders.length}
            </div>
        `;
    }
    
    html += '<table class="table table-hover">';
    html += '<thead><tr><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–¢–æ–≤–∞—Ä</th><th>–ü—Ä–∏—Ö–æ–¥</th><th>–†–∞—Å—Ö–æ–¥</th><th>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</th><th>–ò—Ç–æ–≥</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>';
    html += '<tbody>';
    
    summary.forEach(item => {
        const isComposite = item.is_composite ? '<span class="badge bg-info ms-2" title="–°–æ—Å—Ç–∞–≤–Ω–æ–π –∞—Ä—Ç–∏–∫—É–ª">üß©</span>' : '';
        
        html += '<tr>';
        html += '<td><code>' + (item.article || '---') + '</code> ' + isComposite + '</td>';
        html += '<td>' + (item.name || '---') + '</td>';
        html += '<td class="text-end">' + (item.total_in || 0) + '</td>';
        html += '<td class="text-end">' + (item.total_out || 0) + '</td>';
        html += '<td class="text-end">' + (item.inventory !== null && item.inventory !== undefined ? item.inventory : '-') + '</td>';
        html += '<td class="text-end"><strong>' + (item.final_stock || 0) + '</strong></td>';
        html += '<td>';
        html += '<button class="btn btn-sm btn-info" onclick="showDetails(\'' + item.article + '\')">';
        html += '<i class="fas fa-eye"></i>';
        html += '</button>';
        html += '</td>';
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    html += '</div>';
    
    // –ò—Ç–æ–≥–∏
    let totalIn = summary.reduce((sum, item) => sum + (item.total_in || 0), 0);
    let totalOut = summary.reduce((sum, item) => sum + (item.total_out || 0), 0);
    let totalStock = summary.reduce((sum, item) => sum + (item.final_stock || 0), 0);
    
    html += '<div class="row mt-4">';
    html += '<div class="col-md-4"><div class="card"><div class="card-body text-center">';
    html += '<h6 class="text-muted">–í—Å–µ–≥–æ –ø—Ä–∏—Ö–æ–¥</h6>';
    html += '<h3 class="text-success">' + totalIn + '</h3>';
    html += '</div></div></div>';
    
    html += '<div class="col-md-4"><div class="card"><div class="card-body text-center">';
    html += '<h6 class="text-muted">–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥</h6>';
    html += '<h3 class="text-danger">' + totalOut + '</h3>';
    html += '</div></div></div>';
    
    html += '<div class="col-md-4"><div class="card"><div class="card-body text-center">';
    html += '<h6 class="text-muted">–ò—Ç–æ–≥–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫</h6>';
    html += '<h3 class="text-primary">' + totalStock + '</h3>';
    html += '</div></div></div>';
    html += '</div>';
    
    document.getElementById('reportResults').innerHTML = html;
}

function showDetails(article) {
    if (!currentReportData.detailed) return;
    
    const operations = currentReportData.detailed.filter(op => op.article === article);
    
    if (operations.length === 0) return;
    
    let html = '<h6>–û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ —Ç–æ–≤–∞—Ä—É ' + article + '</h6>';
    html += '<table class="table table-sm">';
    html += '<thead><tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–ó–∞–∫–∞–∑</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th></tr></thead>';
    html += '<tbody>';
    
    operations.forEach(op => {
        let badgeClass = '';
        if (op.type === '–ü—Ä–∏—Ö–æ–¥') badgeClass = 'success';
        else if (op.type === '–†–∞—Å—Ö–æ–¥') badgeClass = 'warning';
        else if (op.type === '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è') badgeClass = 'info';
        else badgeClass = 'secondary';
        
        html += '<tr>';
        html += '<td>' + op.date + '</td>';
        html += '<td><span class="badge bg-' + badgeClass + '">' + op.type + '</span></td>';
        html += '<td>' + op.order_number + '</td>';
        html += '<td class="text-end">' + op.quantity + '</td>';
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    document.getElementById('detailsModalBody').innerHTML = html;
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

function exportToExcel() {
    if (!currentReportData.summary || currentReportData.summary.length === 0) return;
    
    let csv = "–ê—Ä—Ç–∏–∫—É–ª,–ù–∞–∑–≤–∞–Ω–∏–µ,–ü—Ä–∏—Ö–æ–¥,–†–∞—Å—Ö–æ–¥,–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è,–ò—Ç–æ–≥,–¢–∏–ø\n";
    
    currentReportData.summary.forEach(item => {
        const type = item.is_composite ? '—Å–æ—Å—Ç–∞–≤–Ω–æ–π' : '–æ–±—ã—á–Ω—ã–π';
        csv += `"${item.article}","${item.name}",${item.total_in || 0},${item.total_out || 0},${item.inventory || ''},${item.final_stock || 0},"${type}"\n`;
    });
    
    csv += "\n\n–î–µ—Ç–∞–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏\n";
    csv += "–î–∞—Ç–∞,–¢–∏–ø,–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞,–ê—Ä—Ç–∏–∫—É–ª,–ù–∞–∑–≤–∞–Ω–∏–µ,–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ,–¢–∏–ø –∞—Ä—Ç–∏–∫—É–ª–∞\n";
    
    currentReportData.detailed.forEach(op => {
        const articleType = op.is_composite ? '—Å–æ—Å—Ç–∞–≤–Ω–æ–π' : '–æ–±—ã—á–Ω—ã–π';
        csv += `"${op.date}","${op.type}","${op.order_number}","${op.article}","${op.product_name}",${op.quantity},"${articleType}"\n`;
    });
    
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `report_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function printReport() {
    if (!currentReportData.summary || currentReportData.summary.length === 0) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>–û—Ç—á–µ—Ç</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { padding: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th { background: #f8f9fa; }
                th, td { border: 1px solid #dee2e6; padding: 8px; text-align: left; }
                .badge-composite { background: #6f42c1; color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.7rem; }
                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <h2 class="mb-4">–û—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥</h2>
            <div id="printContent"></div>
            <button class="btn btn-primary no-print mt-4" onclick="window.print()">–ü–µ—á–∞—Ç—å</button>
            <button class="btn btn-secondary no-print mt-4 ms-2" onclick="window.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </body>
        </html>
    `);
    
    let content = '<table class="table table-bordered">';
    content += '<thead><tr><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–¢–æ–≤–∞—Ä</th><th>–ü—Ä–∏—Ö–æ–¥</th><th>–†–∞—Å—Ö–æ–¥</th><th>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</th><th>–ò—Ç–æ–≥</th><th>–¢–∏–ø</th></tr></thead>';
    content += '<tbody>';
    
    currentReportData.summary.forEach(item => {
        const type = item.is_composite ? '<span class="badge-composite">—Å–æ—Å—Ç–∞–≤–Ω–æ–π</span>' : '–æ–±—ã—á–Ω—ã–π';
        content += `<tr>
            <td>${item.article}</td>
            <td>${item.name}</td>
            <td>${item.total_in || 0}</td>
            <td>${item.total_out || 0}</td>
            <td>${item.inventory || '-'}</td>
            <td><strong>${item.final_stock || 0}</strong></td>
            <td>${type}</td>
        </tr>`;
    });
    
    content += '</tbody></table>';
    
    printWindow.document.getElementById('printContent').innerHTML = content;
    printWindow.document.close();
}

function showError(message) {
    document.getElementById('reportResults').innerHTML = `
        <div class="text-center py-5 text-danger">
            <i class="fas fa-exclamation-triangle fa-4x mb-3"></i>
            <p>${message}</p>
        </div>
    `;
    document.getElementById('exportBtn').style.display = 'none';
    document.getElementById('printBtn').style.display = 'none';
}
</script>
{% endblock %}
